name: mangabackupconverter_workspace
description: Manga Backup Converter monorepo workspace.

publish_to: none

version: 0.1.0

environment:
  sdk: ^3.11.0

workspace:
  - packages/*

dependencies:
  flutter:
    sdk: flutter

dependency_overrides:
  propertylistserialization:
    git:
      url: https://github.com/getBoolean/dart-propertylistserialization.git
      ref: fix/webCompatibility

dev_dependencies:
  melos: ^7.4.0

melos:
  sdkPath: auto
  command:
    bootstrap:
      # It seems so that running "pub get" in parallel has some issues (like
      # https://github.com/dart-lang/pub/issues/3404). Disabling this feature
      # makes the CI much more stable.
      # runPubGetInParallel: false
      hooks:
        # Activate the coverage package globally so that it can be used in the
        # `test` command.
        post: flutter pub global activate coverage ^1.11.1

  # See https://github.com/firebase/flutterfire/blob/master/melos.yaml for more examples
  scripts:
    # Custom lint is only applied to the packages and not the root app because of a dependency conflict with `integration_test` and `melos`
    pub:
      run: melos run dart:pkg --no-select && melos run flutter:pkg --no-select
      description: Run `dart pub get` in all packages.

    dart:pkg:
      run: dart pub get
      exec:
        failFast: true
        # concurrency: 1
      description: Run `dart pub get` in the selected package.
      packageFilters:
        noDependsOn: flutter

    flutter:pkg:
      run: flutter pub get
      exec:
        failFast: true
        # concurrency: 1
      description: Run `flutter pub get` in the selected package.
      packageFilters:
        dependsOn: flutter

    lint:
      run: melos run analyze && melos run custom_lint
      description: Run `melos run analyze` and `melos run custom_lint` in all packages.

    # which use different versions of `path`.
    analyze:
      run: melos run analyze:pkg --no-select
      description: Run `dart analyze` in all packages.

    analyze:pkg:
      run: dart analyze --fatal-infos lib
      exec:
        failFast: true
        # concurrency: 1
      description: Run `dart analyze` on all packages.

    custom_lint:
      run: melos run custom_lint:pkg --no-select
      description: Run `dart run custom_lint` in all packages with custom lints.

    custom_lint:pkg:
      run: dart run custom_lint
      exec:
        failFast: true
        # concurrency: 1
      description: Run `dart run custom_lint` in the selected package.
      packageFilters:
        dependsOn: custom_lint

    upgrade:
      run: |
        dart pub upgrade
        melos run upgrade:pkg --no-select
      description: Run `dart pub upgrade` in all packages.

    upgrade:pkg:
      run: dart pub upgrade
      exec:
        failFast: true
      description: Run `dart pub upgrade` in the selected package.

    upgrade-major:
      run: |
        dart pub upgrade
        melos run upgrade:pkg --no-select
      description: Run `dart pub upgrade --major-versions` in all packages.

    upgrade-major:pkg:
      run: dart pub upgrade --major-versions
      exec:
        failFast: true
      description: Run `dart pub upgrade --major-versions` in the selected package.

    format:
      exec: dart format .
      description: Run `dart format` in all packages.

    fix:
      exec: dart fix --apply
      description: Run `dart fix --apply` in all packages.

    verify_format:
      run: dart format --output=none --set-exit-if-changed .
      exec:
        failFast: true
      description: Verify formatting was applied.

    generate:
      run: melos run assets && melos run generate:pkg --no-select && melos run format
      description: Run `build_runner build` in all packages.

    generate:pkg:
      run: dart run build_runner build --delete-conflicting-outputs
      exec:
        # concurrency: 5
        failFast: true
      description: Run `build_runner build` in the selected packages.
      packageFilters:
        dependsOn: build_runner

    watch:pkg:
      run: dart run build_runner watch --delete-conflicting-outputs
      exec:
        # concurrency: 1
        failFast: true
      description: Run `build_runner watch` in the selected package. If all is selected, the command will only run in the first package.
      packageFilters:
        dependsOn: build_runner

    assets:
      run: melos run assets:pkg --no-select
      description: Run `flutter pub run fluttergen pubspec.yaml` all packages with assets gen.

    assets:pkg:
      run: flutter pub run fluttergen pubspec.yaml
      exec:
        failFast: true
      description: Run `flutter pub run fluttergen pubspec.yaml` in the selected package.
      packageFilters:
        dependsOn: flutter_gen

    dart_test:pkg:
      run: dart pub global run coverage:test_with_coverage
      exec:
        failFast: true
        concurrency: 1
      description: Run Dart tests for a specific package in this project.
      packageFilters:
        dirExists: test
        dependsOn: test
        noDependsOn: flutter jni
        ignore:
          - web_wasm_runner
          - swiftsoup
          - jsoup_jni
          - app

    flutter_test:pkg:
      run: flutter test --no-pub --coverage
      exec:
        failFast: true
        # concurrency: 1
      description: Run Flutter tests for a specific package in this project.
      packageFilters:
        flutter: true
        dirExists: test
        dependsOn: flutter_test
        noDependsOn: jni

    test:
      run: melos run flutter_test && melos run dart_test
      description: Run all tests in this project.

    flutter_test:
      run: melos run flutter_test:pkg --no-select
      description: Run all Flutter tests in this project.

    cli:
      run: dart run packages/mangabackupconverter_cli/bin/mangabackupconverter_cli.dart
      description: Run the CLI directly (faster than `dart run mangabackupconverter_cli:mangabackupconverter_cli`).

    jnigen:
      exec: dart run tool/generate_jni_bindings.dart
      description: Generate JNI bindings for jsoup (prepends bundled JRE to PATH).
      packageFilters:
        scope: jsoup_jni

    jni_setup:
      exec: dart run tool/generate_jni_bindings.dart --jni-setup
      description: Build dartjni.dll via jni:setup with auto-discovered system JDK.
      packageFilters:
        scope: jsoup_jni

    dart_test:
      run: melos run dart_test:pkg --no-select
      description: Run all Dart tests in this project.

    dart_test_no_coverage:pkg:
      run: dart test --reporter expanded
      exec:
        failFast: true
        concurrency: 1
      description: Run Dart tests without coverage (for Windows/macOS CI).
      packageFilters:
        dirExists: test
        dependsOn: test
        noDependsOn: flutter jni
        ignore:
          - web_wasm_runner
          - swiftsoup
          - jsoup_jni
          - app

    dart_test_no_coverage:
      run: melos run dart_test_no_coverage:pkg --no-select
      description: Run all Dart tests without coverage.

    flutter_web_test:pkg:
      run: flutter test --platform chrome
      exec:
        failFast: true
        concurrency: 1
      description: Run Flutter web tests for a specific package in this project.
      packageFilters:
        flutter: true
        dirExists: test
        dependsOn: flutter_test
        noDependsOn: jni

    dart_web_test:pkg:
      run: dart test --reporter expanded --platform chrome
      exec:
        failFast: true
        concurrency: 1
      description: Run Dart web tests for a specific package in this project.
      packageFilters:
        dirExists: test
        dependsOn: test
        noDependsOn: flutter jni
        ignore:
          - swiftsoup
          - jsoup_jni
          - wasmer_runner
          - wasm3
          - scraper
          - jsoup
          - app_lints
          - assets
          - constants
          - wasm_runner
          - app

    web_test:
      run: melos run flutter_web_test && melos run dart_web_test
      description: Run all web-compatible tests in Chrome.

    flutter_web_test:
      run: melos run flutter_web_test:pkg --no-select
      description: Run all Flutter web tests in this project.

    dart_web_test:
      run: melos run dart_web_test:pkg --no-select
      description: Run all Dart web tests in this project.
