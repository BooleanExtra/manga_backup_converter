# Aidoku WASM ABI

> Discovered from `aidoku-rs/crates/lib/src/` source (not from binary inspection).
> All export/import names are generated by the `register_source!` macro and `#[link(wasm_import_module)]` attributes.

---

## Exports (functions Dart calls on the plugin)

All exports return `i32`:
- **Positive** → pointer to a result buffer in WASM linear memory (8-byte header + postcard payload)
- **Negative** → error code (-1: general, -2: not supported, -3: login required)
- **Zero** → success with no payload

| Export name                    | Parameters (i32 unless noted) | Description                                  |
|--------------------------------|-------------------------------|----------------------------------------------|
| `start`                        | none → void                   | Initialize source; call before all others    |
| `get_search_manga_list`        | `query_rid, page, filters_rid`         | Search manga; page is 1-indexed                       |
| `get_manga_update`             | `manga_key_rid, needs_details, needs_chapters` | Fetch manga details/chapters (i32 booleans) |
| `get_page_list`                | `manga_descriptor_rid, chapter_descriptor_rid` | Fetch page URLs (manga first, chapter second) |
| `free_result`                  | `ptr` → void                           | Free a result buffer returned by the above            |
| `get_manga_list`               | `listing_index, page`                  | (optional) Browse listing, page is 1-indexed          |
| `get_listings`                 | none                                   | (optional) Available listing names                    |
| `get_home`                     | none                          | (optional) Home screen sections              |
| `get_filters`                  | none                          | (optional) Filter list                       |
| `get_settings`                 | none                          | (optional) Settings definitions              |
| `get_alternate_covers`         | `manga_descriptor_rid`                 | (optional) Alternate cover URLs → `Vec<String>` |
| `get_image_request`            | `url_rid, context_rid`                 | (optional) Custom image request → `ImageRequest` |
| `get_base_url`                 | none                                   | (optional) Source base URL → `String`        |
| `get_page_description`         | `page_descriptor_rid`                  | (optional) Page description string           |
| `process_page_image`           | `image_rid, context_rid`               | (optional) Process page image bytes → `Vec<u8>` |
| `handle_notification`          | `notification_rid`                     | (optional) Receive notification; void return |
| `handle_deep_link`             | `url_rid`                              | (optional) Handle deep link → `DeepLinkResult?` |
| `handle_basic_login`           | `key_rid, username_rid, password_rid`  | (optional) Basic auth login; 0=success, <0=fail |
| `handle_web_login`             | `key_rid, cookies_rid`                 | (optional) Web/cookie login; 0=success, <0=fail |
| `handle_key_migration`         | `manga_key_rid, chapter_key_rid`       | (optional) Migrate key → new key `String?`  |

**Result buffer layout** (at the returned pointer in WASM memory):
```
[u32 length LE][u32 capacity LE][<length> bytes of postcard-encoded payload]
```

---

## RID (Resource ID) convention

String and struct parameters are passed as **RIDs** (i32 handles into a host-side buffer registry):

1. Host stores the serialized data in `_buffers: Map<int, Uint8List>` keyed by a monotonically-increasing RID.
2. WASM receives the RID as an `i32` parameter.
3. WASM calls `std::buffer_len(rid)` → length, then `std::_read_buffer(rid, buf_ptr, len)` to copy data into its own memory.
4. Host implements `std::destroy(rid)` to remove from registry.

---

## Imports (functions Dart must implement for each WASM module)

### Module: `"env"`

| Name             | Signature (WASM i32/i64/f64)          | Dart behavior                              |
|------------------|----------------------------------------|--------------------------------------------|
| `_print`         | `(ptr: i32, size: i32) → void`        | Log UTF-8 string from WASM memory          |
| `_sleep`         | `(seconds: i32) → void`               | Sleep (stub: no-op acceptable)             |
| `_send_partial_result` | `(ptr: i32) → void`            | Stream partial results (stub acceptable)   |

### Module: `"std"`

| Name             | Signature                              | Dart behavior                              |
|------------------|----------------------------------------|--------------------------------------------|
| `destroy`        | `(rid: i32) → void`                   | Remove buffer at RID from registry         |
| `buffer_len`     | `(rid: i32) → i32`                    | Return `_buffers[rid]!.length`             |
| `read_buffer`    | `(rid: i32, buf: i32, len: i32) → i32`| Copy buffer bytes to WASM memory at `buf` |
| `_current_date`  | `() → f64`                            | Return `DateTime.now().millisecondsSinceEpoch / 1000.0` |
| `utc_offset`     | `() → i64`                            | Return `DateTime.now().timeZoneOffset.inSeconds` |
| `_parse_date`    | `(str: i32, len: i32, fmt: i32, fmt_len: i32, locale: i32, locale_len: i32, timezone: i32, timezone_len: i32) → f64` | Parse date string |

### Module: `"net"`

| Name             | Signature                              | Dart behavior                              |
|------------------|----------------------------------------|--------------------------------------------|
| `init`           | `(method: i32) → i32`                 | Create HTTP request; return new request RID |
| `send`           | `(rid: i32) → i32`                    | Execute HTTP request; replace RID with response RID |
| `send_all`       | `(rids_ptr: i32, len: i32) → i32`    | Execute multiple requests in parallel      |
| `set_url`        | `(rid: i32, ptr: i32, len: i32) → i32` | Set URL (read from WASM memory)           |
| `set_header`     | `(rid: i32, k_ptr: i32, k_len: i32, v_ptr: i32, v_len: i32) → i32` | Set HTTP header |
| `set_body`       | `(rid: i32, ptr: i32, len: i32) → i32` | Set request body                          |
| `set_timeout`    | `(rid: i32, value: f64) → i32`        | Set timeout in seconds                     |
| `data_len`       | `(rid: i32) → i32`                    | Response body length                       |
| `read_data`      | `(rid: i32, buf: i32, size: i32) → i32` | Copy response body to WASM memory        |
| `get_status_code`| `(rid: i32) → i32`                    | HTTP status code                           |
| `get_header`     | `(rid: i32, k_ptr: i32, k_len: i32) → i32` | Return header value as new RID         |
| `html`           | `(rid: i32) → i32`                    | Parse response as HTML; return HTML RID    |
| `get_image`      | `(rid: i32) → i32`                    | Extract image; return image data RID       |
| `net_set_rate_limit` | `(permits: i32, period: i32, unit: i32) → void` | Configure rate limit (stub)   |

**HttpMethod enum (i32 discriminant):** `0=GET, 1=POST, 2=PUT, 3=PATCH, 4=DELETE, 5=HEAD`

### Module: `"html"`

All functions take and return RIDs (i32). The HTML document is parsed by the host and stored by RID.

| Name             | Behavior                                                     |
|------------------|--------------------------------------------------------------|
| `parse`          | `(ptr, len) → rid` — Parse UTF-8 HTML; return document RID  |
| `select`         | `(rid, selector_ptr, selector_len) → rid` — CSS select (NodeList RID) |
| `select_first`   | `(rid, selector_ptr, selector_len) → rid` — First match     |
| `text`           | `(rid) → rid` — Normalized text content as string RID       |
| `html`           | `(rid) → rid` — Inner HTML as string RID                    |
| `outer_html`     | `(rid) → rid` — Outer HTML as string RID                    |
| `attr`           | `(rid, attr_ptr, attr_len) → rid` — Attribute value as RID  |
| `size`           | `(rid) → i32` — NodeList length                             |
| `html_get`       | `(rid, index) → rid` — Nth element from NodeList            |
| `tag_name`       | `(rid) → rid` — Tag name string RID                         |
| `id`             | `(rid) → rid` — Element id string RID                       |

### Module: `"defaults"`

| Name | Signature                                              | Dart behavior                         |
|------|--------------------------------------------------------|---------------------------------------|
| `get`| `(key_ptr: i32, len: i32) → i32`                      | Return 0 (None) — no persisted prefs |
| `set`| `(key_ptr: i32, len: i32, kind: i32, val: i32) → i32` | No-op; return 0                       |

---

## String/RID read pattern (inside WASM)

When WASM receives a RID for a string parameter, it does:
```rust
let len = unsafe { std::buffer_len(rid) } as usize;
let mut buf = vec![0u8; len];
unsafe { std::_read_buffer(rid, buf.as_mut_ptr(), len) };
let s = String::from_utf8(buf).unwrap();
```

So Dart must store string data in `_buffers[rid]` as UTF-8 bytes.

---

## Calling `get_search_manga_list`

```
1. Dart encodes query String → UTF-8 bytes → stores at _buffers[queryRid]
2. Dart encodes filters (Vec<FilterValue>) → postcard → stores at _buffers[filtersRid]
3. Dart calls: ptr = plugin.callFunction('get_search_manga_list', [queryRid, page, filtersRid])
4. Dart reads: header = readMemory(ptr, 8)
               len = header.buffer.asByteData().getUint32(0, Endian.little)
               payload = readMemory(ptr + 8, len)
5. Dart decodes payload with PostcardReader → MangaPageResult
6. Dart calls: plugin.callFunction('free_result', [ptr])
7. Dart calls: std::destroy(queryRid), std::destroy(filtersRid)
```

---

## New optional export parameter encoding

### Parameter encoding formats

| Encoding | Description |
|----------|-------------|
| raw UTF-8 | Plain `utf8.encode(string)` bytes — no postcard framing |
| postcard Manga | `encodeManga(m)` — full postcard-serialized Rust Manga struct |
| postcard Page | `encodePage(p)` — postcard PageContent enum + thumbnail + has_description + description |
| postcard Vec<u8> | `encodeImageResponse(bytes)` — varint(len) + raw bytes |
| postcard HashMap<String,String> | `encodeStringMap(m)` — varint(count) + (key,value) string pairs |
| postcard Option<HashMap<String,String>> | `encodeOptionalStringMap(m)` — 0x00 for None, or 0x01 + HashMap encoding |

### Export-by-export encoding

| Export | Parameter 1 | Parameter 2 | Parameter 3 |
|--------|------------|------------|------------|
| `get_alternate_covers` | postcard Manga | — | — |
| `get_image_request` | raw UTF-8 URL | postcard Option<HashMap> context | — |
| `get_page_description` | postcard Page | — | — |
| `process_page_image` | postcard Vec<u8> image | postcard Option<HashMap> context | — |
| `handle_notification` | raw UTF-8 notification | — | — |
| `handle_deep_link` | raw UTF-8 URL | — | — |
| `handle_basic_login` | raw UTF-8 key | raw UTF-8 username | raw UTF-8 password |
| `handle_web_login` | raw UTF-8 key | postcard HashMap cookies | — |
| `handle_key_migration` (manga) | raw UTF-8 manga key | `-1` (i32 sentinel = no chapter) | — |
| `handle_key_migration` (chapter) | raw UTF-8 manga key | raw UTF-8 chapter key | — |

### `handle_key_migration` dual usage

- **Manga migration**: `handle_key_migration(manga_key_rid, -1)` → returns new manga key as `String`
- **Chapter migration**: `handle_key_migration(manga_key_rid, chapter_key_rid)` → returns new chapter key as `String`
- Returns 0 (zero ptr) if migration is not needed or not supported.
