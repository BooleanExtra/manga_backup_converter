# Aidoku WASM ABI

> Binary-verified against 4 fixture plugins (multi.mangadex-v12, en.asurascans-v11, en.weebcentral-v6, multi.mangafire-v5).
> Run `dart test packages/wasm_plugin_loader/test/wasm/wasm_imports_audit_test.dart --reporter expanded` to re-verify.
>
> **Note on naming**: Compiled binaries use **unprefixed** names (`print`, `read_buffer`, `current_date`, `parse_date`, `send_partial_result`).
> The aidoku-rs source uses leading-underscore names (`_print`, etc.) — these are legacy aliases registered for compatibility.
> `env::abort` is a Rust/WASM panic handler not in the aidoku-rs source but declared by all compiled binaries.

---

## Exports (functions Dart calls on the plugin)

All exports return `i32`:
- **Positive** → pointer to a result buffer in WASM linear memory (8-byte header + postcard payload)
- **Negative** → error code (-1: general, -2: not supported, -3: login required)
- **Zero** → success with no payload

| Export name                    | Parameters (i32 unless noted) | Description                                  |
|--------------------------------|-------------------------------|----------------------------------------------|
| `start`                        | none → void                   | Initialize source; call before all others (always generated by `register_source!`) |
| `get_search_manga_list`        | `query_rid, page, filters_rid`         | Search manga; page is 1-indexed                       |
| `get_manga_update`             | `manga_key_rid, needs_details, needs_chapters` | Fetch manga details/chapters (i32 booleans) |
| `get_page_list`                | `manga_descriptor_rid, chapter_descriptor_rid` | Fetch page URLs (manga first, chapter second) |
| `free_result`                  | `ptr` → void                           | Free a result buffer returned by the above            |
| `get_manga_list`               | `listing_index, page`                  | (optional) Browse listing, page is 1-indexed          |
| `get_listings`                 | none                                   | (optional) Available listing names                    |
| `get_home`                     | none                          | (optional) Home screen sections              |
| `get_filters`                  | none                          | (optional) Filter list                       |
| `get_settings`                 | none                          | (optional) Settings definitions              |
| `get_alternate_covers`         | `manga_descriptor_rid`                 | (optional) Alternate cover URLs → `Vec<String>` |
| `get_image_request`            | `url_rid, context_rid`                 | (optional) Custom image request → `ImageRequest` |
| `get_base_url`                 | none                                   | (optional) Source base URL → `String`        |
| `get_page_description`         | `page_descriptor_rid`                  | (optional) Page description string           |
| `process_page_image`           | `image_rid, context_rid`               | (optional) Process page image bytes → `Vec<u8>` |
| `handle_notification`          | `notification_rid`                     | (optional) Receive notification; void return |
| `handle_deep_link`             | `url_rid`                              | (optional) Handle deep link → `DeepLinkResult?` |
| `handle_basic_login`           | `key_rid, username_rid, password_rid`  | (optional) Basic auth login; 0=success, <0=fail |
| `handle_web_login`             | `key_rid, cookies_rid`                 | (optional) Web/cookie login; 0=success, <0=fail |
| `handle_key_migration`         | `manga_key_rid, chapter_key_rid`       | (optional) Migrate key → new key `String?`  |

**Result buffer layout** (at the returned pointer in WASM memory):
```
[u32 length LE][u32 capacity LE][<length> bytes of postcard-encoded payload]
```

---

## RID (Resource ID) convention

String and struct parameters are passed as **RIDs** (i32 handles into a host-side buffer registry):

1. Host stores the serialized data in `_buffers: Map<int, Uint8List>` keyed by a monotonically-increasing RID.
2. WASM receives the RID as an `i32` parameter.
3. WASM calls `std::buffer_len(rid)` → length, then `std::_read_buffer(rid, buf_ptr, len)` to copy data into its own memory.
4. Host implements `std::destroy(rid)` to remove from registry.

---

## Imports (functions Dart must implement for each WASM module)

### Module: `"env"`

Binary-verified: mangadex ✓, asurascans ✓, weebcentral ✓, mangafire ✓ (all 4 plugins).

| Name                   | Signature (WASM)                      | Dart behavior                                        |
|------------------------|---------------------------------------|------------------------------------------------------|
| `print`                | `(ptr: i32, size: i32) → void`        | Log UTF-8 string from WASM memory                    |
| `abort`                | `() → void`                           | Rust panic handler — logs message, no-op             |
| `send_partial_result`  | `(ptr: i32) → void`                   | Stream partial result (result buf at ptr)            |
| `_print`               | `(ptr: i32, size: i32) → void`        | Legacy alias for `print` (aidoku-rs source name)     |
| `_sleep`               | `(seconds: i32) → void`               | Sleep stub (no-op; not observed in any binary)       |
| `_send_partial_result` | `(ptr: i32) → void`                   | Legacy alias for `send_partial_result`               |

### Module: `"std"`

Binary-verified: all 4 plugins use `destroy`, `buffer_len`, `read_buffer`; mangadex + mangafire use `current_date`; asurascans + mangafire use `parse_date`.

| Name             | Signature                              | Dart behavior                              |
|------------------|----------------------------------------|--------------------------------------------|
| `destroy`        | `(rid: i32) → void`                   | Remove buffer at RID from registry         |
| `buffer_len`     | `(rid: i32) → i32`                    | Return `_buffers[rid]!.length`             |
| `read_buffer`    | `(rid: i32, buf: i32, len: i32) → i32`| Copy buffer bytes to WASM memory at `buf` |
| `current_date`   | `() → f64`                            | Return `DateTime.now().millisecondsSinceEpoch / 1000.0` |
| `parse_date`     | `(str: i32, len: i32, fmt: i32, fmt_len: i32, locale: i32, locale_len: i32, timezone: i32, timezone_len: i32) → f64` | Parse date string |
| `utc_offset`     | `() → i64`                            | Return `DateTime.now().timeZoneOffset.inSeconds` (not observed in any binary) |
| `_current_date`  | `() → f64`                            | Legacy alias for `current_date`            |
| `_parse_date`    | `(str: i32, len: i32, …) → f64`       | Legacy alias for `parse_date`              |
| `_read_buffer`   | `(rid: i32, buf: i32, len: i32) → i32`| Legacy alias for `read_buffer`             |

### Module: `"net"`

Binary-verified: all 4 plugins use `init`, `send`, `set_url`; see aggregate table for per-plugin coverage.

| Name                 | Signature                              | Dart behavior                                  |
|----------------------|----------------------------------------|------------------------------------------------|
| `init`               | `(method: i32) → i32`                 | Create HTTP request; return new request RID    |
| `send`               | `(rid: i32) → i32`                    | Execute HTTP request; returns response RID     |
| `send_all`           | `(rids_ptr: i32, len: i32) → i32`     | Execute multiple requests in parallel          |
| `set_url`            | `(rid: i32, ptr: i32, len: i32) → i32`| Set URL (read from WASM memory)                |
| `set_header`         | `(rid: i32, k_ptr: i32, k_len: i32, v_ptr: i32, v_len: i32) → i32` | Set HTTP header |
| `set_body`           | `(rid: i32, ptr: i32, len: i32) → i32`| Set request body                               |
| `set_timeout`        | `(rid: i32, value: f64) → i32`        | Set timeout in seconds (not in any binary)     |
| `data_len`           | `(rid: i32) → i32`                    | Response body length                           |
| `read_data`          | `(rid: i32, buf: i32, size: i32) → i32`| Copy response body to WASM memory             |
| `get_status_code`    | `(rid: i32) → i32`                    | HTTP status code                               |
| `get_header`         | `(rid: i32, k_ptr: i32, k_len: i32) → i32` | Return header value as new RID           |
| `html`               | `(rid: i32) → i32`                    | Parse response as HTML; return HTML RID        |
| `get_image`          | `(rid: i32) → i32`                    | Extract image; return image data RID (no binary) |
| `set_rate_limit`     | `(permits: i32, period: i32, unit: i32) → void` | Configure rate limit (stub); binary name |
| `net_set_rate_limit` | `(permits: i32, period: i32, unit: i32) → void` | Legacy alias for `set_rate_limit`        |

**HttpMethod enum (i32 discriminant):** `0=GET, 1=POST, 2=PUT, 3=PATCH, 4=DELETE, 5=HEAD`

### Module: `"html"`

All functions take and return RIDs (i32). Binary-verified: asurascans, weebcentral, mangafire use html module; mangadex does not.

| Name             | Binary? | Behavior                                                     |
|------------------|---------|--------------------------------------------------------------|
| `select`         | ✓       | `(rid, selector_ptr, selector_len) → rid` — CSS select (NodeList RID) |
| `select_first`   | ✓       | `(rid, selector_ptr, selector_len) → rid` — First match     |
| `text`           | ✓       | `(rid) → rid` — Normalized text content as string RID       |
| `attr`           | ✓       | `(rid, attr_ptr, attr_len) → rid` — Attribute value as RID  |
| `size`           | ✓       | `(rid) → i32` — NodeList length                             |
| `get`            | ✓       | `(rid, index) → rid` — Nth element from NodeList            |
| `own_text`       | ✓       | `(rid) → rid` — Direct text (no children) as string RID     |
| `first`          | ✓       | `(rid) → rid` — First element from NodeList                 |
| `last`           | ✓       | `(rid) → rid` — Last element from NodeList                  |
| `parse_fragment` | ✓       | `(ptr, len) → rid` — Parse HTML fragment; return RID        |
| `parse`          | —       | `(ptr, len) → rid` — Parse UTF-8 HTML; return document RID  |
| `html`           | —       | `(rid) → rid` — Inner HTML as string RID                    |
| `outer_html`     | —       | `(rid) → rid` — Outer HTML as string RID                    |
| `html_get`       | —       | `(rid, index) → rid` — Nth element (alias for `get`)        |
| `tag_name`       | —       | `(rid) → rid` — Tag name string RID                         |
| `id`             | —       | `(rid) → rid` — Element id string RID                       |
| `class_name`     | —       | `(rid) → rid` — Class attribute as string RID               |
| `parent`         | —       | `(rid) → rid` — Parent element RID                          |
| `children`       | —       | `(rid) → rid` — Children NodeList RID                       |
| `next`           | —       | `(rid) → rid` — Next sibling RID                            |
| `previous`       | —       | `(rid) → rid` — Previous sibling RID                        |

### Binary-verified import aggregate

31 unique imports observed across the 4 fixture plugins (2026-02-19).
`✓` = present in that plugin's binary; `-` = not used.

| module   | name                   | result | mangadex | asurascans | weebcentral | mangafire |
|----------|------------------------|--------|----------|------------|-------------|-----------|
| defaults | get                    | i32    | ✓        | -          | -           | ✓         |
| defaults | set                    | i32    | ✓        | -          | -           | -         |
| env      | abort                  | void   | ✓        | ✓          | ✓           | ✓         |
| env      | print                  | void   | ✓        | ✓          | ✓           | ✓         |
| env      | send_partial_result    | void   | ✓        | -          | ✓           | ✓         |
| html     | attr                   | i32    | -        | ✓          | ✓           | ✓         |
| html     | first                  | i32    | -        | -          | ✓           | -         |
| html     | get                    | i32    | -        | ✓          | ✓           | ✓         |
| html     | last                   | i32    | -        | -          | ✓           | -         |
| html     | own_text               | i32    | -        | ✓          | -           | ✓         |
| html     | parse_fragment         | i32    | -        | -          | -           | ✓         |
| html     | select                 | i32    | -        | ✓          | ✓           | ✓         |
| html     | select_first           | i32    | -        | ✓          | ✓           | ✓         |
| html     | size                   | i32    | -        | ✓          | ✓           | ✓         |
| html     | text                   | i32    | -        | ✓          | ✓           | ✓         |
| net      | data_len               | i32    | ✓        | ✓          | -           | ✓         |
| net      | get_status_code        | i32    | ✓        | -          | -           | -         |
| net      | html                   | i32    | -        | ✓          | ✓           | ✓         |
| net      | init                   | i32    | ✓        | ✓          | ✓           | ✓         |
| net      | read_data              | i32    | ✓        | ✓          | -           | ✓         |
| net      | send                   | i32    | ✓        | ✓          | ✓           | ✓         |
| net      | send_all               | i32    | ✓        | -          | -           | -         |
| net      | set_body               | i32    | ✓        | -          | -           | -         |
| net      | set_header             | i32    | ✓        | -          | -           | ✓         |
| net      | set_rate_limit         | void   | ✓        | ✓          | -           | -         |
| net      | set_url                | i32    | ✓        | ✓          | ✓           | ✓         |
| std      | buffer_len             | i32    | ✓        | ✓          | ✓           | ✓         |
| std      | current_date           | f64    | ✓        | -          | -           | ✓         |
| std      | destroy                | void   | ✓        | ✓          | ✓           | ✓         |
| std      | parse_date             | f64    | -        | ✓          | -           | ✓         |
| std      | read_buffer            | i32    | ✓        | ✓          | ✓           | ✓         |

### Module: `"defaults"`

| Name | Signature                                              | Dart behavior                                                     |
|------|--------------------------------------------------------|-------------------------------------------------------------------|
| `get`| `(key_ptr: i32, len: i32) → i32`                      | Look up `"$sourceId.$key"` in `HostStore.defaults`; return RID (>0) or 0 (None) |
| `set`| `(key_ptr: i32, len: i32, kind: i32, val: i32) → i32` | Store postcard bytes at `"$sourceId.$key"`; remove if `kind=6` (Null) |

**`DefaultValue` kind discriminants** (aidoku-rs `DefaultValue::as_byte()`):
`Bool=1, Int=2, Float=3, String=4, StringArray=5, Null=6`
For all non-null kinds, `val` is an RID pointing to postcard-encoded bytes (not a raw scalar).

**Seeding defaults at load time** — use `WasmPluginLoader.load(aixBytes, defaults: {'key': value})`.
Values can be `Uint8List` (stored as-is), `String` (UTF-8 encoded), `bool`, or `int`.
For a JSON-parsed field (e.g. a login token read via `defaults_get_json::<T>`), the stored bytes
must be postcard-encoded `String(json_text)` — e.g. for `"{}"`:  `[0x02, 0x7B, 0x7D]`.

---

## String/RID read pattern (inside WASM)

When WASM receives a RID for a string parameter, it does:
```rust
let len = unsafe { std::buffer_len(rid) } as usize;
let mut buf = vec![0u8; len];
unsafe { std::_read_buffer(rid, buf.as_mut_ptr(), len) };
let s = String::from_utf8(buf).unwrap();
```

So Dart must store string data in `_buffers[rid]` as UTF-8 bytes.

---

## Calling `get_search_manga_list`

```
1. Dart encodes query String → UTF-8 bytes → stores at _buffers[queryRid]
2. Dart encodes filters (Vec<FilterValue>) → postcard → stores at _buffers[filtersRid]
3. Dart calls: ptr = plugin.callFunction('get_search_manga_list', [queryRid, page, filtersRid])
4. Dart reads: header = readMemory(ptr, 8)
               len = header.buffer.asByteData().getUint32(0, Endian.little)
               payload = readMemory(ptr + 8, len)
5. Dart decodes payload with PostcardReader → MangaPageResult
6. Dart calls: plugin.callFunction('free_result', [ptr])
7. Dart calls: std::destroy(queryRid), std::destroy(filtersRid)
```

---

## New optional export parameter encoding

### Parameter encoding formats

| Encoding | Description |
|----------|-------------|
| raw UTF-8 | Plain `utf8.encode(string)` bytes — no postcard framing |
| postcard Manga | `encodeManga(m)` — full postcard-serialized Rust Manga struct |
| postcard Page | `encodePage(p)` — postcard PageContent enum + thumbnail + has_description + description |
| postcard Vec<u8> | `encodeImageResponse(bytes)` — varint(len) + raw bytes |
| postcard HashMap<String,String> | `encodeStringMap(m)` — varint(count) + (key,value) string pairs |
| postcard Option<HashMap<String,String>> | `encodeOptionalStringMap(m)` — 0x00 for None, or 0x01 + HashMap encoding |

### Export-by-export encoding

| Export | Parameter 1 | Parameter 2 | Parameter 3 |
|--------|------------|------------|------------|
| `get_alternate_covers` | postcard Manga | — | — |
| `get_image_request` | raw UTF-8 URL | postcard Option<HashMap> context | — |
| `get_page_description` | postcard Page | — | — |
| `process_page_image` | postcard Vec<u8> image | postcard Option<HashMap> context | — |
| `handle_notification` | raw UTF-8 notification | — | — |
| `handle_deep_link` | raw UTF-8 URL | — | — |
| `handle_basic_login` | raw UTF-8 key | raw UTF-8 username | raw UTF-8 password |
| `handle_web_login` | raw UTF-8 key | postcard HashMap cookies | — |
| `handle_key_migration` (manga) | raw UTF-8 manga key | `-1` (i32 sentinel = no chapter) | — |
| `handle_key_migration` (chapter) | raw UTF-8 manga key | raw UTF-8 chapter key | — |

### `handle_key_migration` dual usage

- **Manga migration**: `handle_key_migration(manga_key_rid, -1)` → returns new manga key as `String`
- **Chapter migration**: `handle_key_migration(manga_key_rid, chapter_key_rid)` → returns new chapter key as `String`
- Returns 0 (zero ptr) if migration is not needed or not supported.
